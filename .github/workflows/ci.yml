name: test
on:
  workflow_dispatch:
  pull_request:
  push:
    branches:
      - master
jobs:
  test:
    runs-on: ubuntu-22.04
    steps:
      - name: Check out repository code
        uses: actions/checkout@v4
      - run: echo "The ${{ github.repository }} repository has been cloned to the runner."
      - run: echo "The workflow is now ready to test your code on the runner."
      - name: Run dynamic mishmashvm bootstrap path
        run: |
          pushd .
          cd ..
          git clone --depth=1 https://github.com/cosinusoidally/mishmashvm.git
          cd mishmashvm/auxiliary/
          time ./bootstrap_alt5.sh &> /dev/shm/log_mm_dynamic.txt
          cd ../libc_portable_proto/tcc_bin/
          sha256sum *o
          popd
      - name: Clean up build artifacts
        run: |
          ./mk_really_clean
      - name: Run dynamically linked bootstrap path
        run: |
          time ./mk_m2min &> /dev/shm/log_dynamic.txt
          grep ^tcc_27 /dev/shm/log_dynamic.txt
      - name: Clean up build artifacts
        run: |
          ./mk_really_clean
      - name: Run statically linked bootstrap path
        run: |
          time ./mk_from_bootstrap_seed &> /dev/shm/log_static.txt
          grep ^tcc_27 /dev/shm/log_static.txt
      - run: echo "This job's status is ${{ job.status }}."
